{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Video and Active Users Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>Video Call - Room: {{ room_name }}</h5>
                        <span class="badge bg-primary">{{ user_email }}</span>
                    </div>
                    <div id="connection-status" class="alert alert-info">Connecting...</div>
                </div>
                <div class="card-body p-0">
                    <div class="row">
                        <!-- Active Users Sidebar -->
                        <div class="col-md-3">
                            <div class="active-users-sidebar">
                                <div class="active-users-header">
                                    <h6>Active Users <span id="activeCount" class="badge bg-success">0</span></h6>
                                </div>
                                <div class="active-users-list" id="activeUsersList">
                                    <!-- Active users will be listed here -->
                                </div>
                            </div>
                        </div>
                        <!-- Video Grid -->
                        <div class="col-md-9">
                            <div id="videos-container">
                                <div class="video-container small">
                                    <video id="localVideo" autoplay playsinline muted></video>
                                    <div class="video-label">You ({{ user_email }})</div>
                                </div>
                            </div>
                            <div class="controls-container">
                                <button class="control-button" id="leaveBtn" data-tooltip="Leave Call">
                                    <i class="fas fa-phone-slash"></i>
                                </button>
                                <button class="control-button" id="toggleVideoBtn" data-tooltip="Toggle Video" data-active="true" disabled>
                                    <i class="fas fa-video"></i>
                                </button>
                                <button class="control-button" id="toggleAudioBtn" data-tooltip="Toggle Audio" data-active="true" disabled>
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Chat</h5>
                    <div id="chat-connection-status" class="alert alert-info">Connecting...</div>
                </div>
                <div class="card-body chat-card-body">
                    <div class="chat-container" id="chat-messages">
                        <!-- Chat messages will be inserted here -->
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="chat-input" placeholder="Type your message...">
                        <button class="btn btn-primary" id="send-message">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const roomName = '{{ room_name }}';
const userEmail = '{{ user_email }}';  // Get user email from Django context

let localStream = null;
let peerConnections = {};
let videoSocket = null;
let chatSocket = null;
let isConnecting = false;
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;
const configuration = {
    iceServers: [
        { 
            urls: [
                'stun:stun.l.google.com:19302',
                'stun:stun1.l.google.com:19302',
                'stun:stun2.l.google.com:19302',
                'stun:stun3.l.google.com:19302',
                'stun:stun4.l.google.com:19302'
            ]
        }
    ]
};

// Function to update active users list
function updateActiveUsersList(users) {
    const activeUsersList = document.getElementById('activeUsersList');
    activeUsersList.innerHTML = '';
    const activeCount = document.getElementById('activeCount');
    
    users.forEach(user => {
        const userItem = document.createElement('div');
        userItem.className = `active-user-item ${user.username === userEmail ? 'current-user' : ''}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'user-avatar';
        avatar.textContent = user.username.charAt(0).toUpperCase();
        
        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        
        const name = document.createElement('div');
        name.className = 'user-name';
        name.textContent = user.username === userEmail ? `${user.username} (You)` : user.username;
        
        const controls = document.createElement('div');
        controls.className = 'user-controls';
        
        if (user.hasVideo) {
            const videoStatus = document.createElement('span');
            videoStatus.innerHTML = '<i class="fas fa-video"></i>';
            controls.appendChild(videoStatus);
        } else {
            const videoStatus = document.createElement('span');
            videoStatus.innerHTML = '<i class="fas fa-video-slash"></i>';
            controls.appendChild(videoStatus);
        }
        
        if (user.hasAudio) {
            const audioStatus = document.createElement('span');
            audioStatus.innerHTML = '<i class="fas fa-microphone"></i>';
            controls.appendChild(audioStatus);
        } else {
            const audioStatus = document.createElement('span');
            audioStatus.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            controls.appendChild(audioStatus);
        }
        
        userInfo.appendChild(name);
        userInfo.appendChild(controls);
        userItem.appendChild(avatar);
        userItem.appendChild(userInfo);
        activeUsersList.appendChild(userItem);
    });
    
    activeCount.textContent = users.length;
}

// WebSocket connection handling
function getWebSocketUrl(type) {
    const hostname = window.location.hostname;
    const port = window.location.port;
    const isSecure = window.location.protocol === 'https:';
    const wsProtocol = isSecure ? 'wss:' : 'ws:';
    return `${wsProtocol}//${hostname}:${port}/ws/${type}/${roomName}/`;
}

function createVideoSocket() {
    if (videoSocket && (videoSocket.readyState === WebSocket.OPEN || videoSocket.readyState === WebSocket.CONNECTING)) {
        return;
    }

    updateConnectionStatus('video', 'Connecting...');
    
    try {
        const wsUrl = getWebSocketUrl('video');
        console.log('Connecting to video WebSocket:', wsUrl);
        videoSocket = new WebSocket(wsUrl);

        videoSocket.onopen = () => {
            console.log('Video WebSocket connected');
            updateConnectionStatus('video', 'Connected');
            reconnectAttempts = 0;
            
            // Send join message with user email
            videoSocket.send(JSON.stringify({
                type: 'join',
                username: userEmail,
                hasVideo: true,
                hasAudio: true
            }));
        };

        videoSocket.onclose = () => {
            console.log('Video WebSocket closed');
            updateConnectionStatus('video', 'Disconnected', true);
            
            // Try to reconnect
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                setTimeout(() => {
                    reconnectAttempts++;
                    createVideoSocket();
                }, 2000 * Math.pow(2, reconnectAttempts));
            }
        };

        videoSocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            switch (data.type) {
                case 'user_joined':
                    console.log('User joined:', data.username);
                    updateActiveUsersList(data.users);
                    break;
                    
                case 'user_left':
                    console.log('User left:', data.username);
                    break;
                    
                case 'active_users_list':
                    console.log('Active users update:', data.users);
                    updateActiveUsersList(data.users);
                    break;
                    
                case 'user_status_update':
                    console.log('User status update:', data.username, data.hasVideo, data.hasAudio);
                    break;
            }
        };

        videoSocket.onerror = (error) => {
            console.error('Video WebSocket error:', error);
            updateConnectionStatus('video', 'Connection error', true);
        };
    } catch (error) {
        console.error('Error creating video WebSocket:', error);
        updateConnectionStatus('video', 'Connection error', true);
    }
}

// Initialize connections when page loads
createVideoSocket();
</script>

{% block extra_css %}
<style>
    .active-users-sidebar {
        height: 100%;
        border-right: 1px solid #dee2e6;
        padding: 15px;
        display: flex;
        flex-direction: column;
    }

    .active-users-header {
        padding: 10px;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 15px;
    }

    .active-users-list {
        flex: 1;
        overflow-y: auto;
    }

    .active-user-item {
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 8px;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
    }

    .active-user-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }

    .active-user-item.current-user {
        background: #e3f2fd;
        border: 1px solid #90caf9;
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #007bff;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .user-info {
        flex: 1;
    }

    .user-name {
        font-weight: 500;
        margin-bottom: 4px;
    }

    .user-controls {
        display: flex;
        gap: 8px;
        color: #6c757d;
    }

    .video-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }

    .video-container video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .video-label {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
    }

    .controls-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        padding: 15px;
    }

    .control-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .control-button:hover {
        background: #e9ecef;
    }

    .control-button[data-active="false"] {
        background: #dc3545;
        color: white;
    }
</style>
{% endblock %}
{% endblock %}